<!--  --><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Story Image URL</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #39FF14;
        }
        .result {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
        .success { color: #39FF14; }
        .error { color: #ff4444; }
        img {
            max-width: 100%;
            border: 2px solid #39FF14;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            background: #39FF14;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #2dd60f;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #000;
            border: 1px solid #39FF14;
            color: #fff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test de URLs de Historias</h1>
    
    <div class="test-section">
        <h2>1. ConfiguraciÃ³n</h2>
        <label>Backend URL:</label>
        <input type="text" id="backendUrl" value="http://127.0.0.1:8000" placeholder="http://127.0.0.1:8000">
        
        <label>Token de autenticaciÃ³n:</label>
        <input type="text" id="authToken" placeholder="Tu token de autenticaciÃ³n">
        
        <button onclick="testStoryReply()">Probar Respuesta a Historia</button>
    </div>

    <div class="test-section">
        <h2>2. Resultado del Test</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Manual de URL</h2>
        <label>URL de la historia (relativa o completa):</label>
        <input type="text" id="testUrl" placeholder="/media/stories/imagen.jpg">
        <button onclick="testUrlConstruction()">Construir URL</button>
        <div id="urlResult"></div>
    </div>

    <script>
        async function testStoryReply() {
            const backendUrl = document.getElementById('backendUrl').value;
            const token = document.getElementById('authToken').value;
            const resultsDiv = document.getElementById('results');
            
            if (!token) {
                resultsDiv.innerHTML = '<div class="result error">Por favor ingresa un token de autenticaciÃ³n</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="result">Cargando mensajes...</div>';
            
            try {
                // Obtener lista de chats
                const chatsResponse = await fetch(`${backendUrl}/api/messaging/chats/`, {
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!chatsResponse.ok) {
                    throw new Error(`Error al obtener chats: ${chatsResponse.status}`);
                }
                
                const chatsData = await chatsResponse.json();
                console.log('Chats:', chatsData);
                
                if (chatsData.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="result error">No tienes chats disponibles</div>';
                    return;
                }
                
                // Obtener mensajes del primer chat
                const firstChatId = chatsData.results[0].id;
                const messagesResponse = await fetch(`${backendUrl}/api/messaging/chats/${firstChatId}/messages/`, {
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error(`Error al obtener mensajes: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                console.log('Mensajes:', messagesData);
                
                // Buscar mensajes con story_preview
                const storyMessages = messagesData.results.filter(msg => msg.story_preview);
                
                if (storyMessages.length === 0) {
                    resultsDiv.innerHTML = '<div class="result error">No se encontraron mensajes con respuestas a historias</div>';
                    return;
                }
                
                // Mostrar informaciÃ³n de las historias
                let html = '<div class="result success">âœ“ Se encontraron ' + storyMessages.length + ' mensajes con historias</div>';
                
                storyMessages.forEach((msg, index) => {
                    const story = msg.story_preview;
                    const mediaUrl = constructUrl(story.media_url, backendUrl);
                    const avatarUrl = story.user.avatar_url ? constructUrl(story.user.avatar_url, backendUrl) : '';
                    
                    html += `
                        <div class="result">
                            <h3>Historia ${index + 1}</h3>
                            <p><strong>Usuario:</strong> ${story.user.display_name} (@${story.user.username})</p>
                            <p><strong>Tipo:</strong> ${story.media_type}</p>
                            <p><strong>URL Original:</strong> ${story.media_url}</p>
                            <p><strong>URL Construida:</strong> ${mediaUrl}</p>
                            ${avatarUrl ? `<p><strong>Avatar URL:</strong> ${avatarUrl}</p>` : ''}
                            <p><strong>Expirada:</strong> ${story.is_expired ? 'SÃ­' : 'No'}</p>
                            ${story.media_type === 'image' ? `<img src="${mediaUrl}" alt="Historia" onerror="this.style.border='2px solid red'; this.alt='Error al cargar imagen';">` : ''}
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }
        
        function constructUrl(url, backendUrl) {
            if (!url) return '';
            if (url.startsWith('http')) return url;
            
            // Remover /api del backend URL
            const cleanBackendUrl = backendUrl.replace('/api', '');
            
            // Asegurar que la URL tenga un slash al inicio
            const cleanUrl = url.startsWith('/') ? url : `/${url}`;
            
            return `${cleanBackendUrl}${cleanUrl}`;
        }
        
        function testUrlConstruction() {
            const testUrl = document.getElementById('testUrl').value;
            const backendUrl = document.getElementById('backendUrl').value;
            const resultDiv = document.getElementById('urlResult');
            
            const constructedUrl = constructUrl(testUrl, backendUrl);
            
            resultDiv.innerHTML = `
                <div class="result">
                    <p><strong>URL Original:</strong> ${testUrl}</p>
                    <p><strong>Backend URL:</strong> ${backendUrl}</p>
                    <p><strong>URL Construida:</strong> ${constructedUrl}</p>
                </div>
                ${testUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? `
                    <img src="${constructedUrl}" alt="Test" onerror="this.style.border='2px solid red'; this.alt='Error al cargar imagen';">
                ` : ''}
            `;
        }
        
        // Cargar token del localStorage si existe
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                document.getElementById('authToken').value = savedToken;
            }
        });
        
        // Guardar token en localStorage cuando cambie
        document.getElementById('authToken').addEventListener('change', (e) => {
            localStorage.setItem('authToken', e.target.value);
        });
    </script>
</body>
</html>
