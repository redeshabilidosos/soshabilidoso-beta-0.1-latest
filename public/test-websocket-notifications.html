<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket Notificaciones</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background: #fff3cd;
            color: #856404;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #667eea;
        }
        .info-box p {
            margin: 5px 0;
            color: #666;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 20px 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-success {
            color: #4ec9b0;
        }
        .log-error {
            color: #f48771;
        }
        .log-info {
            color: #569cd6;
        }
        .log-warning {
            color: #dcdcaa;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-group {
            margin: 20px 0;
        }
        .token-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå Test WebSocket Notificaciones</h1>
        <p>Prueba de conexi√≥n WebSocket en tiempo real</p>

        <div class="info-box">
            <h3>Estado de Conexi√≥n</h3>
            <p><strong>Estado:</strong> <span id="connectionStatus" class="status-badge disconnected">Desconectado</span></p>
            <p><strong>URL WebSocket:</strong> <code id="wsUrl">-</code></p>
            <p><strong>Backend:</strong> <code>http://127.0.0.1:8000</code></p>
            <p><strong>Protocolo:</strong> <span id="protocol">-</span></p>
        </div>

        <div class="info-box">
            <h3>Token JWT</h3>
            <p><strong>Usuario de prueba:</strong> admin@test.com</p>
            <div class="token-display" id="tokenDisplay">Obteniendo token...</div>
        </div>

        <div class="button-group">
            <button onclick="connectWebSocket()">üîå Conectar WebSocket</button>
            <button onclick="disconnectWebSocket()">üîå Desconectar</button>
            <button onclick="sendTestNotification()" id="sendBtn" disabled>üì§ Enviar Notificaci√≥n de Prueba</button>
            <button onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
        </div>

        <div class="info-box">
            <h3>üìã Logs de Conexi√≥n</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">Esperando conexi√≥n...</div>
            </div>
        </div>

        <div class="info-box">
            <h3>‚úÖ Checklist de Verificaci√≥n</h3>
            <p id="check1">‚è≥ Backend corriendo en puerto 8000</p>
            <p id="check2">‚è≥ Daphne (ASGI) iniciado</p>
            <p id="check3">‚è≥ WebSocket endpoint disponible</p>
            <p id="check4">‚è≥ Token JWT v√°lido</p>
            <p id="check5">‚è≥ Conexi√≥n WebSocket establecida</p>
        </div>

        <div class="info-box">
            <h3>üîß Troubleshooting</h3>
            <p><strong>Error 404:</strong> Backend no est√° corriendo con Daphne. Usa: <code>npm run soshabilidoso</code></p>
            <p><strong>Error 1006:</strong> Conexi√≥n cerrada inesperadamente. Verifica que Daphne est√© corriendo.</p>
            <p><strong>Error 401:</strong> Token JWT inv√°lido o expirado. Refresca la p√°gina.</p>
            <p><strong>Error 403:</strong> Token no autorizado. Verifica credenciales.</p>
        </div>
    </div>

    <script>
        let ws = null;
        let token = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 3;

        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('es-ES');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            let icon = 'üìù';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'info') icon = 'üîÑ';
            
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Funci√≥n para actualizar estado
        function updateStatus(status, text) {
            const statusBadge = document.getElementById('connectionStatus');
            statusBadge.className = `status-badge ${status}`;
            statusBadge.textContent = text;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = status !== 'connected';
        }

        // Funci√≥n para actualizar checklist
        function updateCheck(checkId, status, text) {
            const check = document.getElementById(checkId);
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            check.textContent = `${icon} ${text}`;
        }

        // Obtener token JWT
        async function getToken() {
            try {
                addLog('Obteniendo token JWT...', 'info');
                updateCheck('check4', 'loading', 'Obteniendo token JWT...');
                
                const response = await fetch('http://127.0.0.1:8000/api/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                token = data.access;
                
                document.getElementById('tokenDisplay').textContent = token;
                addLog('Token JWT obtenido correctamente', 'success');
                updateCheck('check4', 'success', 'Token JWT v√°lido');
                
                return token;
            } catch (error) {
                addLog(`Error al obtener token: ${error.message}`, 'error');
                updateCheck('check4', 'error', `Error al obtener token: ${error.message}`);
                return null;
            }
        }

        // Verificar backend
        async function checkBackend() {
            try {
                addLog('Verificando backend en puerto 8000...', 'info');
                updateCheck('check1', 'loading', 'Verificando backend...');
                
                const response = await fetch('http://127.0.0.1:8000/api/', {
                    method: 'GET',
                });

                if (response.ok) {
                    addLog('Backend respondiendo correctamente', 'success');
                    updateCheck('check1', 'success', 'Backend corriendo en puerto 8000');
                    updateCheck('check2', 'success', 'Daphne (ASGI) iniciado');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`Backend no disponible: ${error.message}`, 'error');
                updateCheck('check1', 'error', 'Backend no disponible');
                updateCheck('check2', 'error', 'Daphne no iniciado');
                return false;
            }
        }

        // Conectar WebSocket
        async function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('Ya hay una conexi√≥n WebSocket activa', 'warning');
                return;
            }

            // Verificar backend primero
            const backendOk = await checkBackend();
            if (!backendOk) {
                addLog('No se puede conectar: Backend no disponible', 'error');
                return;
            }

            // Obtener token
            if (!token) {
                token = await getToken();
                if (!token) {
                    addLog('No se puede conectar: Token no disponible', 'error');
                    return;
                }
            }

            try {
                updateStatus('connecting', 'Conectando...');
                updateCheck('check3', 'loading', 'Conectando a WebSocket...');
                
                const wsUrl = `ws://127.0.0.1:8000/ws/notifications/?token=${token}`;
                document.getElementById('wsUrl').textContent = wsUrl;
                
                addLog(`Conectando a: ${wsUrl}`, 'info');
                
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    addLog('‚úÖ WebSocket conectado exitosamente', 'success');
                    updateStatus('connected', 'Conectado');
                    updateCheck('check3', 'success', 'WebSocket endpoint disponible');
                    updateCheck('check5', 'success', 'Conexi√≥n WebSocket establecida');
                    document.getElementById('protocol').textContent = ws.protocol || 'WebSocket';
                    reconnectAttempts = 0;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addLog(`üì® Mensaje recibido: ${JSON.stringify(data)}`, 'success');
                        
                        // Si es una notificaci√≥n, mostrarla
                        if (data.type === 'notification') {
                            addLog(`üîî Notificaci√≥n: ${data.message}`, 'info');
                        }
                    } catch (error) {
                        addLog(`Mensaje recibido (raw): ${event.data}`, 'info');
                    }
                };

                ws.onerror = (error) => {
                    addLog(`‚ùå Error en WebSocket: ${error.message || 'Error desconocido'}`, 'error');
                    updateCheck('check3', 'error', 'Error en WebSocket endpoint');
                    updateCheck('check5', 'error', 'Error en conexi√≥n WebSocket');
                };

                ws.onclose = (event) => {
                    addLog(`üîå WebSocket cerrado. C√≥digo: ${event.code}, Raz√≥n: ${event.reason || 'Sin raz√≥n'}`, 'warning');
                    updateStatus('disconnected', 'Desconectado');
                    updateCheck('check5', 'error', 'Conexi√≥n WebSocket cerrada');
                    
                    // Intentar reconectar
                    if (reconnectAttempts < maxReconnectAttempts && event.code !== 1000) {
                        reconnectAttempts++;
                        addLog(`üîÑ Intentando reconectar (${reconnectAttempts}/${maxReconnectAttempts})...`, 'info');
                        setTimeout(connectWebSocket, 2000);
                    }
                };

            } catch (error) {
                addLog(`‚ùå Error al crear WebSocket: ${error.message}`, 'error');
                updateStatus('disconnected', 'Error');
                updateCheck('check3', 'error', `Error: ${error.message}`);
            }
        }

        // Desconectar WebSocket
        function disconnectWebSocket() {
            if (ws) {
                addLog('Cerrando conexi√≥n WebSocket...', 'info');
                ws.close(1000, 'Cierre manual');
                ws = null;
                updateStatus('disconnected', 'Desconectado');
            } else {
                addLog('No hay conexi√≥n activa para cerrar', 'warning');
            }
        }

        // Enviar notificaci√≥n de prueba
        function sendTestNotification() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('No hay conexi√≥n WebSocket activa', 'error');
                return;
            }

            try {
                const testMessage = {
                    type: 'test_notification',
                    message: 'Esta es una notificaci√≥n de prueba',
                    timestamp: new Date().toISOString()
                };
                
                ws.send(JSON.stringify(testMessage));
                addLog(`üì§ Mensaje enviado: ${JSON.stringify(testMessage)}`, 'success');
            } catch (error) {
                addLog(`‚ùå Error al enviar mensaje: ${error.message}`, 'error');
            }
        }

        // Limpiar logs
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">Logs limpiados</div>';
        }

        // Inicializar al cargar
        window.addEventListener('load', () => {
            addLog('P√°gina cargada. Haz clic en "Conectar WebSocket" para iniciar', 'info');
            
            // Auto-conectar despu√©s de 1 segundo
            setTimeout(() => {
                addLog('Iniciando conexi√≥n autom√°tica...', 'info');
                connectWebSocket();
            }, 1000);
        });

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close(1000, 'P√°gina cerrada');
            }
        });
    </script>
</body>
</html>
